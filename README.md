### Divorcepath

Your path to a new life.

[https://www.divorcepath.com](https://www.divorcepath.com)

Calculator API last updated August 10, 2021

Divorcepath is a workflow platform for lawyers, their assistants, and their clients.  Users can exchange information and collaborate using a set of specialized family law tools. 

This project is managed with Jira. 

The app is built using GraphQL/React/Reactstrap/SCSS. Forms built with the Formik (yup for validation).

Many pages include charts by [Charts.js](https://www.chartjs.org/) implemented with [React-Chartjs-2](https://github.com/jerairrest/react-chartjs-2).

Payments are managed with [Stripe](https://www.stripe.com).

API (including the PostgreSQL DB) is built using Prisma and located [here](https://github.com/aeturneus/divorcepath-api)

---
### Contents

1. Infrastructure
2. Settings & Configuration
3. Dependencies
4. Commands
5. Git & Branching
6. Testing
7. Releasing
8. Data Structure
9. GraphQL Queries, Resolvers and Schema
10. Application Roles
11. Profile & Directory Pages
12. Tool Pages
13. Marketing Pages
14. Support Pages
17. Calculator API
18. [Stripe](#18-Stripe)
---

### 1. Infrastructure

The following explains how the `development`, `production` and `staging` environments for this app are managed and configured.

#### Where is DNS configured for this app?

DNS for the app is configured and managed via [Namesilo](https://namesilo.com).

#### Where does the database live?

The database is hosted via [MongoDB](https://mongodb.com). A single deployment `divorcepath` exists with a `production` database for the `production` environment and a `staging` database for the `staging` environment. Additionally, the "Oplog Access" add-on has been enabled to [improve the performance of Meteor in `production`](https://galaxy-guide.meteor.com/apm-optimize-your-app-for-oplog.html).

#### Where does this app live?

The app can be run locally using `npm run dev`. Development commits are managed on the `development` branch in github.

The app uses continuous deployment from github to [https://galaxy.meteor.com](https://galaxy.meteor.com), managed using [![CircleCI]](https://circleci.com/gh/aeturneus/divorcepath).

There are two deployments:

1. `staging` which is accessed via `https://staging.divorcepath.com` and is used to test a release in a production environment _before_ being deployed to `production`. Staging commits are managed on the 'staging' branch in github.

2. `production` which is accessed via `https://www.divorcepath.com` and is the live, customer-facing server. Production commits are managed on the main branch in github.

Deployment to these domains is controlled via NPM scripts defined in the `package.json` file at the root of the project, `npm run staging` and `npm run production`. The command to deploy to galaxy is `DEPLOY_HOSTNAME=galaxy.meteor.com meteor deploy https://app.divorcepath.com --settings settings-production.json`

#### How does the SSL work?

SSL certificates are generated via the UI at [https://galaxy.meteor.com/divorcepath](https://galaxy.meteor.com/divorcepath). Each application's certificates are managed via the app's settings page:

- [Staging Server Settings Dashboard](https://galaxy.meteor.com/app/staging.divorcepath.com/settings)
- [Production Server Settings Dashboard](https://galaxy.meteor.com/app/produuction.divorcepath.com/settings)

SSL certificates are auto-generated by Galaxy using the Let's Encrypt Certificate Authority and shouldn't require any maintenance. If maintenance or edits are required, locate the "Domains & Encryption" section of the app's settings page (linked above) and click on the domain you'd like to manage.

### 2. Settings & Configuration

Settings for the app are defined in three files at the root of the project:
- `.env` contains the settings specific to all environments which can be overriden
- `.env.development` contains the settings specific to the `development` environment (i.e., when running the app locally or on the divorcepath.herokuapp.com).
- `.env.staging` contains the settings specific to the `staging` environmnet

Each settings file should **_only be used in conjunction with the environment it's intended for_**. Further, each settings file's contents should be restricted to that specific environment (i.e., don't use an API key intended for the `production` environment in `development` and vice-versa—only break this rule when a given service's API key provisioning makes this prohibitive).

#### How do I load the settings file?

Settings files are automatically loaded for you as part of the NPM commands listed below. It's best to rely on these instead of doing it manually.

#### How do I access the accounts used in the settings files?

If you need to obtain an API key, password, or other secret information, you can find this in the [DivorcePath 1Password Vault](https://divorcepath.1password.com). If you do not have access to this, send a direct message to @josh in Slack or email him josh@divorcepath.com.

### 3. Dependencies

Dependencies for `www.divorcepath.com` are installed via NPM and Meteor's Atmosphere package system. Atmosphere dependencies are installed automatically on app startup. NPM dependencies can be installed with the following command **before the first startup of the application**:

```
npm install
```

### 4. Commands

The following NPM commands can be used when working on the app.

#### dev

```
$ npm start
```

Runs the app development server at `http://localhost:3000` and loads the `.env + .env.development` file.

Alternatvely, run through ngrok tunnel by using the following:

```
ngrok http 3000
```

### 5. Git & Branching

[Read the "Managing branches in Git" tutorial in the Git docs](https://git-scm.com/about)

### 6. Testing

Manual testing is any testing where you're _manually_ clicking around the app yourself to test things out. 

### 7. Releasing

Run git push heroku master in the project folder to deploy from `master` branch or git push heroku development:master to deploy from `development` branch. You can also deploy any other branch to the divorcepath.herokuapp.com using `git push heroku branch-to-deploy:master` pattern.

#### Performing a release

In order for a release to be pushed to either the `staging` or `production` environment via continuous integration, code must be pushed to:

- The `master` branch when releasing new code into production.
- The `staging` branch when releasing new code to the `staging` server.
- The `development` branch when committing code for review that is not ready for deployment.

When code is pushed to `master` or `staging`, the continuous integration service should pick this change up and automatically deploy per the rules in the `.circleci/config.yml` file in the app.

### 11. Home, Profile & Directory Pages

Note that users have different profiles (with different profile data schema) depending on their roles. 

### 12. Tool Pages

The app will eventually include the following tools:

* spousal support and child support calculator 
* property division calculator
* parenting calendar
* a tool for negotiating settlement offers
* a wizard for generating customized divorce documents

Of these tools, the support calculator is the only one that will be available at launch. 

#### Child & Spousal Support Calculator

The support calculator (`www.divorcepath.com/support-calculator/calculationId`) allows users to generate reports on the spousal support and child support payable by clients, based on their detailed personal information.

The pro support calculator allows lawyers and assistants to calculate support for clients. A client switcher select box allows the user to change the client. A "new client" feature allows the user to create a new client using profile information entered into the support calculator. Support calculations can be named and saved and a list of saved calculations is shown.  The calculator uses personal information from the client profile to initialize the calculator inputs. Where information is not available the calculator makes an assumption. All variables/inputs can be edited throught the calculator interface. All changes are automatically saved.

A premium calculator designed for client use will use a simplified interface that dispenses with client selection and contains text changes to reflect that the client is calculating support for themselves.

A free to use calculator will be created with simplified inputs and visibly limited options (with a call to action to upgrade for access to more options). For example, only employment income can be entered, and if the user attempts to enter other types of income they will be invited to upgrade.

#### Support Calculation Data Structure

The support calculation data structure is a financial model that generates support scenarios within certain defined parameters based on income, child expenses, tax deductions, tax credits, government benefits, tax payable and both child and spousal support. 

The SupportCalculation schema is as follows:

```
  type SupportCalculation {
    _id: String ## this is the unique identifier for the calculation in mongodb
    _secret: String ## this is a unique secret used to access calculation results at a secure (unguessable) public url
    title: String ## the title of the calculation, set by the user
    createdAt: String ## creation date
    updatedAt: String ## update date
    clientId: String ## unique userId of the user for whom the calculation was created (either the active user or a client of the active user)
    taxYear: String ## the user-selected tax year for which the calculation is created (the financial model and calculations change every year)
    taxTables: TaxTables ## an array of the amounts types that exist for a given taxYear, returned by the API
    clientSupportProfile: Party ## user financial model, returned by API but with user inputs embedded
    exSupportProfile: Party ## ex financial model, returned by API but with user inputs embedded
    relationship: Relationship ## inputs about the relationship used in support calculation
    children: [Child] ## profiles of any children
    childExpenses: ChildExpensesSupport ## calculated apportionment of child-related expenses, returned by API
    childSupport: ChildSupport ## child support calculated by API
    spousalSupport: SpousalSupport ## spousal support scenarios calculated by API
    savedCalculations: [SavedCalculation] ## array of other saved calculations for this user
    client: User ## profile information for user for whom the calculation was created (may contain different profile values than clientSupportProfile)
  }
```

The SupportCalculationInput schema is slightly different:

```
  input SupportCalculationInput {
    _id: String ## the unique identifier for the calculation in mongodb
    title: String ## the title of the calculation, set by the user
    taxYear: String ## the user-selected tax year for which the calculation is created (the financial model and calculations change every year)
    taxTables: TaxTablesInput ## should probably be deprecated, don't think anything is done with TaxTablesInput anymore but havent tested
    client: PartyInput ## financial model for client, including client profile, returned by API but with user inputs embedded
    ex: PartyInput ## financial model for ex, including client profile returned by API but with user inputs embedded
    children: [ChildInput] ## child profiles as modified by user
    childExpenses: AmountArrayInput ## child expense inputs from user
    relationship: RelationshipInput ## relationship input from user
  }
```

##### Party

The `Party` schema is used for each party to the calculation (i.e. client and ex are each a 'party')

```
  type Party {
    name: Name ## party name
    birthDate: String ## date of birth, used by API to calculate eligibility for tax credits and benefits, etc.
    gender: String ## not really used except for front-end display purposes
    residence: String ## province/territory in which party resides, used by API to calculate tax, support
    income: AmountArray ## party's income, in Amount schema
    federalBenefits: AmountArray ## party's federal government benefits
    provincialBenefits: AmountArray ## party's provincial government benefits
    federalDeductions: AmountArray ## party's federal tax deductions
    provincialDeductions: AmountArray ## party's provincial tax deductions
    federalCredits: AmountArray ## party's federal tax credits
    provincialCredits: AmountArray ## party's provincial tax credits
    children: [Child] ## party's children
    childSupport: ChildSupport ## child support results for this party, calculated by API
    partnerIncome: Float
  }
```

The PartyInput schema is very similar to the above but does not include ChildSupport as there are no embedded inputs in the ChildSupport schema.

##### Amount

Tax deductions, credits, and benefits use the `Amount` schema type. Amounts of various types are tabulated in the `AmountTables` and `AmountTable` components, which lists individual amounts as rows in the 'table' using the `AmountModal` component. The `AmountModal` component is collapsible and when expanded displays a customized input forms (the `AmountInputForm` which wraps a subcomponent corresponding to the type of amount, i.e. the Canada Child Benefit has the `CanadaChildBenefitForm`). These input forms allow the user to override parameters for the various different types of amounts. The user can also add an entirely new `Amount` and edit any override parameters, using the "Add Credit" or "Add Benefit" button in the `AmountTable` component.

The `AmountInput` schema is as follows:

```
  input AmountInput {
    key: String ## this value is used by the API to look up the amount type
    label: String ## this value is returned by the API based on the key
    description: String ## this value is returned by the API based on the key
    inputs: [String] ## this array contains the inputs actually used to calculate the amount, based on the relevant formula
    amount: String ## this is the value of the amount used in the financial model, i.e. to calculate support
    defaultInputs: [InputInput] ## this array contains the default values that the calculator would use to calculate the amount, subject to userInputs
    defaultAmount: String ## this array contains the default value of the amount, i.e. the amount that would be calculated if the defaultInputs are used
    userInputs: [InputInput] ## this array contains override inputs provided by the user
    userAmount: String ## this array contains the value of the amount calculated based on any userInputs
    reference: String ## this value is returned by the API based on the key and will be a link to a support page relating to the specific amount type
    childSupport: String ## this value is returned for some amount types by the API based on the key and refers to whether the amount is included in the calculation of child support (not currently used on the front end)
    spousalSupport: String ## this value is returned for some amount types by the API based on the key and refers to whether the amount is included in the calculation of spousal support (not currently used on the front end)
  }
```

#### Property Calculator

The property division calculator will allow users to enter different assets and exemptions and calculate equalization payments required based on different divisions of those assets.

#### Parenting Calendar

The parenting calendar will allow users to configure and adjust a parenting schedule based on a specified rotation, e.g. week-on, week-off; every other weekend; specified dates; etc.

The calendar will automatically calculate each party's total parenting time on an annualized basis, and will track actual parenting time vs. agreed parenting time with a counter for extra or short parenting days.

#### Settlement wizard

Users will be able to generate settlement offers based on support calculations, property calculations, and parenting schedules generated using the tools. The offer can be further customized using a wizard interface. The settlement offer tool will also allow users to respond to settlement offers proposed by the other side, and will provide information as to how the values in the offer compare to standard ranges, apportionment, parenting calendars, etc.

#### Document wizard

Users will be able to generate documents using client profile data by answering questions in a wizard interface. Inputs will be used to further customize the document.

Documents should be provided in Word or PDF form.

### 13. Marketing Pages

The site will need various static publically accessible pages to set out features/blog articles/information.

### 14. Support Pages

The site will need a static publically accessible support site with information on how to use the various tools and with information about family law concepts and terms.

### 17. Calculator API

 Using fields: 
```
  SupportReport/components/SupportsSummary.jsx
  
  spousalSupport.formula
  spousalSupport.minDuration
  spousalSupport.maxDuration

  spousalSupport.scenarios[0].client.monthlySpousalSupport
  spousalSupport.scenarios[0].client.childExpenses.support
  spousalSupport.scenarios[0].client.totalSupport
  spousalSupport.scenarios[2].client.monthlySpousalSupport
  spousalSupport.scenarios[2].client.childExpenses.support
  spousalSupport.scenarios[2].client.totalSupport

  childSupport.formula (ex, client, shared, split)
  childSupport.client.netMonthlySupport
```

Response: 
``` 

{ 
  taxtables: { ... }          // static data
  child_expenses: {
    all: []
    total
  }
  special_expenses: ???       
  client
  ex
  children
  relationship
  child_support: {
    [x] formula <ex | client | shared | split>
    [x] payor
    [x] payee
    client: {
      residence
      guideline_income
      employment_income
      taxable_income
      table_children
      notional_children
      support
      notional_support
      notional_annual_support
      notional_monthly_support
      table_annual_support
      table_monthly_support
      net_annual_support
      [x] net_monthly_support
      monthly_child_support_table_shared
      monthly_child_support_notional_own
      monthly_child_support_table_other
    }
    ex: {
     residence
     guideline_income
     employment_income
     taxable_income
     table_children
     notional_children
     support
     notional_support
     notional_annual_support
     notional_monthly_support
     table_annual_support
     table_monthly_support
     net_annual_support
     net_monthly_support
     monthly_child_support_table_shared
     monthly_child_support_notional_own
     monthly_child_support_table_other
    }
  }
  [x] spousal_support: {
    formula
    minDuration
    maxDuration
    scenarios: [
      {
        client: {
          monthlySpousalSupport
          childExpenses {
            support
          }
          totalSupport
        }
      }
    ]
  }
  client_data
  ex_data
}
```

Update TaxTables:

```
curl --header "Content-Type: application/json" \
  --request POST \
  --data '{"year":"2020"}' \
  https://support-calculator.herokuapp.com/taxtables
```

### 18. Stripe

#### To work with Stripe locally:

1. Install the Stripe CLI [https://stripe.com/docs/stripe-cli#install](https://stripe.com/docs/stripe-cli#install)
2. login `stripe login --api-key ...`, use API key from `Meteor.settings.private.STRIPE_SECRET_KEY`
3. `run stripe listen --forward-to localhost:3000/webhooks/stripe` command
4. update `Meteor.settings.private.STRIPE_WH_SIGNING_SECRET` variable (don’t commit it, can be the same)

Each time when you need to develop - repeat 3 and 4 steps

---
* Add Stripe [API keys](https://dashboard.stripe.com/test/apikeys) to Meteor settings: `STRIPE_PUBLISHABLE_KEY` and `STRIPE_SECRET_KEY`
* Create a [webhook endpoint](https://dashboard.stripe.com/test/webhooks):
  * Endpoint URL: APP_URL + `/webhooks/stripe`
  * Events to send: `checkout.session.completed`, `customer.subscription.created`, `customer.subscription.updated`, `customer.subscription.deleted`
  * Copy a signing secret and add it to Meteor settings - `STRIPE_WH_SIGNING_SECRET`
* For the local development it's better to use Stripe CLI to listen webhook events

* Create [products](https://dashboard.stripe.com/test/subscriptions/products) in Stripe
  * For each plan defined in Divorcepath-API create a Stripe product (for example, "Child Support 1-Month Access")
  * For each product create a pricing plan, plan ID should match plan code in App settings (e.g. `CHILD_SUPPORT_1`) and reference the plan (e.g. `CHILD_SUPPORT_MONTH`)
```
// Create 1-Month Products:

  stripe products create \
  --name="Child Support 1-Month Access" \
  --description="Unlimited access to Divorcepath child support calculator, with unlimited reports." \
  --id=CHILD_SUPPORT_MONTH \
  --type=service

  stripe products create \
  --name="Child Spousal Support 1-Month Access" \
  --description="Unlimited access to Divorcepath child support calculator, with unlimited reports." \
  --id=CHILD_SPOUSAL_SUPPORT_MONTH \
  --type=service

// Create Plans:

  curl https://api.stripe.com/v1/plans \
  -u [key] \
  -d amount=1900 \
  -d currency=cad \
  -d interval=month \
  -d product=CHILD_SUPPORT_MONTH \
  -d id=CHILD_SUPPORT_1

  curl https://api.stripe.com/v1/plans \
  -u [key] \
  -d amount=3900 \
  -d currency=cad \
  -d interval=month \
  -d product=CHILD_SPOUSAL_SUPPORT_MONTH \
  -d id=CHILD_SPOUSAL_SUPPORT_1

// Create Recurring Product:

  stripe products create \
  --name="Child Support Subscription" \
  --description="Unlimited access to Divorcepath child support calculator, with unlimited reports." \
  --id=CHILD_SUPPORT \
  --type=service

  stripe products create \
  --name="Child & Spousal Support Subscription" \
  --description="Unlimited access to Divorcepath child support calculator, with unlimited reports." \
  --id=CHILD_SPOUSAL_SUPPORT \
  --type=service

// Create Plans:

  curl https://api.stripe.com/v1/plans \
  -u [key] \
  -d amount=1900 \
  -d currency=cad \
  -d interval=month \
  -d product=CHILD_SUPPORT \
  -d id=CHILD_SUPPORT

  curl https://api.stripe.com/v1/plans \
  -u [key] \
  -d amount=3900 \
  -d currency=cad \
  -d interval=month \
  -d product=CHILD_SPOUSAL_SUPPORT \
  -d id=CHILD_SPOUSAL_SUPPORT

// Create Firm Product:

  stripe products create \
  --name="Firm Pro Tools Subscription" \
  --description="Unlimited organization access to Divorcepath pro tools, including support calculators with unlimited reports." \
  --id=FIRM \
  --type=service

// Create Plan:

  curl https://api.stripe.com/v1/plans \
  -u [key] \
  -d amount=12900 \
  -d currency=cad \
  -d interval=month \
  -d product=FIRM \
  -d id=FIRM

// Create Solo Pro Product:

  stripe products create \
  --name="Solo Pro Tools Subscription" \
  --description="Unlimited professional access to Divorcepath pro tools, including support calculators with unlimited reports." \
  --id=SOLO \
  --type=service

// Create Plan:

  curl https://api.stripe.com/v1/plans \
  -u [key] \
  -d amount=5900 \
  -d currency=cad \
  -d interval=month \
  -d product=SOLO \
  -d id=SOLO
```
* Configure [appearance and public information](https://dashboard.stripe.com/account/checkout/settings) for Stripe Checkout
* Configure [customer emails and other subscriptions settings](https://dashboard.stripe.com/account/billing/automatic)
